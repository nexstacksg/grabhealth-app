// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== MODELS ====================

// User Model
model User {
  id                     String    @id @default(cuid())
  email                  String    @unique
  password               String
  firstName              String
  lastName               String
  role                   String    @default("USER") // SUPER_ADMIN, MANAGER, USER, PARTNER
  status                 String    @default("PENDING_VERIFICATION") // ACTIVE, INACTIVE, SUSPENDED, PENDING_VERIFICATION
  profileImage           String?
  referralCode           String?   @unique
  uplineId               String?
  partnerId              String?   // Link to partner organization
  refreshToken           String?
  lastLoginAt            DateTime?
  emailVerificationToken String?
  emailVerifiedAt        DateTime?
  emailVerificationCode  String?
  emailVerificationCodeExpires DateTime?
  passwordResetToken     String?
  passwordResetExpires   DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // Relations
  auditLogs            AuditLog[]
  orders               Order[]
  commissionsReceived  Commission[]      @relation("RecipientCommissions")
  commissionsGenerated Commission[]      @relation("UserCommissions")
  relationships        UserRelationship[] @relation("UserRelationships")
  uplineFor           UserRelationship[] @relation("UplineRelationships")
  points              UserPoints?
  userRoles           UserRole[]
  accountRequests     AccountRequest[]
  verificationCodes   EmailVerification[]
  membership          UserMembership?
  upline              User?             @relation("UplineDownline", fields: [uplineId], references: [id])
  downlines           User[]            @relation("UplineDownline")
  bookings            Booking[]
  freeCheckupClaims   FreeCheckupClaim[]
  partner             Partner?          @relation(fields: [partnerId], references: [id])

  @@index([email])
  @@index([referralCode])
  @@index([partnerId])
}

// Audit Log Model
model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String
  entity    String
  entityId  String?
  changes   String? // JSON data
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
}

// ==================== E-COMMERCE MODELS ====================

// Category Model
model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  slug        String   @unique
  description String?
  imageUrl    String?
  parentId    Int?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@index([slug])
  @@index([parentId])
}

// Product Model
model Product {
  id                Int      @id @default(autoincrement())
  name              String
  description       String?
  price             Float
  categoryId        Int?
  imageUrl          String?
  inStock           Boolean  @default(true)
  status            String   @default("ACTIVE") // ACTIVE, INACTIVE, OUT_OF_STOCK, DISCONTINUED
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  category           Category? @relation(fields: [categoryId], references: [id])
  orderItems         OrderItem[]
  productCommissions ProductCommissionTier[]

  @@index([categoryId])
  @@index([status])
}

// Order Model
model Order {
  id              Int      @id @default(autoincrement())
  userId          String
  total           Float    @default(0)
  subtotal        Float    @default(0)
  discount        Float    @default(0)
  tax             Float    @default(0)
  status          String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, CANCELLED, REFUNDED
  paymentStatus   String   @default("PENDING") // PENDING, PAID, FAILED, REFUNDED
  paymentMethod   String?  // CREDIT_CARD, DEBIT_CARD, PAYPAL, BANK_TRANSFER, CASH_ON_DELIVERY
  shippingAddress String?
  billingAddress  String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       OrderItem[]
  commissions Commission[]

  @@index([userId, status])
  @@index([status])
  @@index([paymentStatus])
}

// OrderItem Model
model OrderItem {
  id        Int      @id @default(autoincrement())
  orderId   Int
  productId Int
  quantity  Int      @default(1)
  price     Float
  discount  Float    @default(0)
  createdAt DateTime @default(now())

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

// ==================== MEMBERSHIP MODELS ====================

// MembershipTier Model - Note: Membership is now free upon registration
model MembershipTier {
  id          Int      @id @default(autoincrement())
  name        String   @unique // BASIC, FREE
  description String?
  price       Float    @default(0) // Free membership
  benefits    String?  // JSON data
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userMemberships UserMembership[]
}

// UserMembership Model
model UserMembership {
  id        Int       @id @default(autoincrement())
  userId    String    @unique
  tierId    Int
  status    String    @default("ACTIVE") // ACTIVE, EXPIRED, CANCELLED, SUSPENDED
  startDate DateTime  @default(now())
  endDate   DateTime?
  autoRenew Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  user User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier MembershipTier @relation(fields: [tierId], references: [id])

  @@index([userId])
  @@index([status])
}

// ==================== COMMISSION MODELS ====================

// UserRelationship Model - tracks upline/downline connections
model UserRelationship {
  id               Int      @id @default(autoincrement())
  userId           String
  uplineId         String?
  relationshipLevel Int     @default(1)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  user   User  @relation("UserRelationships", fields: [userId], references: [id], onDelete: Cascade)
  upline User? @relation("UplineRelationships", fields: [uplineId], references: [id], onDelete: SetNull)

  @@unique([userId, uplineId])
  @@index([userId])
  @@index([uplineId])
}

// CommissionTier Model - defines commission rates by level
model CommissionTier {
  id                     Int      @id @default(autoincrement())
  tierLevel              Int      @unique
  tierName               String
  directCommissionRate   Float
  indirectCommissionRate Float
  pointsRate             Int      @default(0)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

// Commission Model - tracks earned commissions
model Commission {
  id                Int      @id @default(autoincrement())
  orderId           Int
  userId            String
  recipientId       String
  amount            Float
  commissionRate    Float
  relationshipLevel Int
  type              String   @default("DIRECT") // DIRECT, INDIRECT, BONUS, OVERRIDE
  status            String   @default("PENDING") // PENDING, APPROVED, PAID, REJECTED, CANCELLED
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  order     Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user      User  @relation("UserCommissions", fields: [userId], references: [id], onDelete: Cascade)
  recipient User  @relation("RecipientCommissions", fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([userId])
  @@index([recipientId])
  @@index([status])
}

// UserPoints Model - tracks points earned from commissions
model UserPoints {
  id        Int      @id @default(autoincrement())
  userId    String   @unique
  points    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ProductCommissionTier Model
model ProductCommissionTier {
  id                      Int      @id @default(autoincrement())
  productId               Int      @unique
  productName             String
  retailPrice             Float
  traderPrice             Float
  distributorPrice        Float
  traderCommissionMin     Float
  traderCommissionMax     Float
  distributorCommissionMin Float
  distributorCommissionMax Float
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// UserRoleType Model
model UserRoleType {
  id                   Int      @id @default(autoincrement())
  roleName             String   @unique // CUSTOMER, SALES, LEADER, MANAGER, COMPANY
  description          String?
  commissionMultiplier Float    @default(1.0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  userRoles UserRole[]
}

// UserRole Model
model UserRole {
  id        Int      @id @default(autoincrement())
  userId    String
  roleId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role UserRoleType @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
}

// VolumeBonusTier Model
model VolumeBonusTier {
  id              Int      @id @default(autoincrement())
  minVolume       Float
  maxVolume       Float?
  bonusPercentage Float
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([minVolume])
}

// ==================== ADDITIONAL MODELS ====================

// GiftItem Model
model GiftItem {
  id                Int      @id @default(autoincrement())
  name              String
  description       String?
  requiredPurchases Int
  imageUrl          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Promotion Model
model Promotion {
  id            Int       @id @default(autoincrement())
  title         String
  description   String?
  discountType  String    // PERCENTAGE, FIXED_AMOUNT
  discountValue Float
  minPurchase   Float?
  startDate     DateTime
  endDate       DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([isActive])
  @@index([startDate, endDate])
}

// AccountRequest Model
model AccountRequest {
  id             Int       @id @default(autoincrement())
  userId         String
  requestType    String    // UPGRADE_MEMBERSHIP, DOWNGRADE_MEMBERSHIP, CANCEL_MEMBERSHIP, ROLE_CHANGE, OTHER
  requestDetails String?
  status         String    @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED
  adminNotes     String?
  processedAt    DateTime?
  processedBy    String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

// EmailVerification Model for login verification
model EmailVerification {
  id         Int      @id @default(autoincrement())
  userId     String
  email      String
  code       String
  type       String   @default("login") // login, registration, password_reset
  expiresAt  DateTime
  verified   Boolean  @default(false)
  attempts   Int      @default(0)
  createdAt  DateTime @default(now())
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([email, code])
  @@index([userId, type])
}

// ==================== PARTNER & BOOKING MODELS ====================

// Partner Model - Healthcare service providers
model Partner {
  id               String    @id @default(cuid())
  name             String
  description      String?
  address          String
  city             String
  state            String
  country          String    @default("Singapore")
  postalCode       String
  phone            String
  email            String    @unique
  website          String?
  imageUrl         String?
  rating           Float     @default(0)
  totalReviews     Int       @default(0)
  isActive         Boolean   @default(true)
  operatingHours   String?   // JSON data for operating hours by day
  specializations  String[]  // Array of specializations
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  services         Service[]
  availability     PartnerAvailability[]
  daysOff          PartnerDaysOff[]
  bookings         Booking[]
  users            User[]    // Partner staff/admin users

  @@index([city])
  @@index([isActive])
}

// Service Model - Services offered by partners
model Service {
  id               String    @id @default(cuid())
  partnerId        String
  name             String
  description      String?
  duration         Int       // Duration in minutes
  price            Float
  category         String    // e.g., "Body Check", "Consultation", "Therapy"
  isActive         Boolean   @default(true)
  requiresApproval Boolean   @default(false)
  maxBookingsPerDay Int      @default(10) // Maximum bookings per day (default: 10)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  partner          Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  bookings         Booking[]

  @@index([partnerId])
  @@index([category])
  @@index([isActive])
}

// PartnerAvailability Model - Regular availability schedule
model PartnerAvailability {
  id               String    @id @default(cuid())
  partnerId        String
  dayOfWeek        Int       // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  startTime        String    // HH:MM format (e.g., "09:00")
  endTime          String    // HH:MM format (e.g., "17:00")
  slotDuration     Int       @default(30) // Duration of each slot in minutes
  maxBookingsPerSlot Int     @default(1)  // How many bookings allowed per slot
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  partner          Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([partnerId, dayOfWeek])
  @@index([partnerId])
}

// PartnerDaysOff Model - Special days off or holidays
model PartnerDaysOff {
  id               String    @id @default(cuid())
  partnerId        String
  date             DateTime  @db.Date
  reason           String?
  isRecurring      Boolean   @default(false) // For annual holidays
  createdAt        DateTime  @default(now())

  // Relations
  partner          Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([partnerId, date])
  @@index([partnerId])
  @@index([date])
}

// Booking Model - User appointments with partners
model Booking {
  id               String    @id @default(cuid())
  userId           String
  partnerId        String
  serviceId        String
  bookingDate      DateTime
  startTime        String    // HH:MM format
  endTime          String    // HH:MM format
  status           String    @default("PENDING") // PENDING, CONFIRMED, CANCELLED, COMPLETED, NO_SHOW
  notes            String?
  cancellationReason String?
  isFreeCheckup    Boolean   @default(false)
  totalAmount      Float
  paymentStatus    String    @default("PENDING") // PENDING, PAID, REFUNDED
  paymentMethod    String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  partner          Partner   @relation(fields: [partnerId], references: [id])
  service          Service   @relation(fields: [serviceId], references: [id])
  freeCheckupClaim FreeCheckupClaim? @relation("BookingCheckupClaim")

  @@index([userId])
  @@index([partnerId])
  @@index([bookingDate])
  @@index([status])
}

// FreeCheckupClaim Model - Track free body check claims
model FreeCheckupClaim {
  id               String    @id @default(cuid())
  userId           String
  claimDate        DateTime  @default(now())
  expiryDate       DateTime  // Usually 1 year from claim date
  status           String    @default("ACTIVE") // ACTIVE, USED, EXPIRED
  usedBookingId    String?   @unique
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  usedBooking      Booking?  @relation("BookingCheckupClaim", fields: [usedBookingId], references: [id])

  @@unique([userId, status]) // Only one active claim per user
  @@index([userId])
  @@index([status])
  @@index([expiryDate])
}